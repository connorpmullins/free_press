name: Deploy Staging

on:
  push:
    branches: [main]

jobs:
  deploy:
    name: Alias to dev.warrant.ink
    runs-on: ubuntu-latest

    steps:
      - name: Install Vercel CLI
        run: npm install -g vercel

      - name: Wait for Vercel deployment
        run: sleep 30

      - name: Get latest preview deployment URL
        id: get-url
        run: |
          URL=$(vercel ls --token=${{ secrets.VERCEL_TOKEN }} --scope=${{ secrets.VERCEL_ORG_ID }} 2>/dev/null | grep -m1 "https://" | awk '{print $2}' || echo "")
          if [ -z "$URL" ]; then
            echo "Could not find deployment URL, using direct deploy"
            URL=$(vercel deploy --token=${{ secrets.VERCEL_TOKEN }} --scope=${{ secrets.VERCEL_ORG_ID }})
          fi
          echo "url=$URL" >> "$GITHUB_OUTPUT"
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

      - name: Alias to dev.warrant.ink
        run: vercel alias ${{ steps.get-url.outputs.url }} dev.warrant.ink --token=${{ secrets.VERCEL_TOKEN }} --scope=${{ secrets.VERCEL_ORG_ID }}
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
